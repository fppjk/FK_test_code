<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>文件格式转换 - CSV / JSON</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f4f4f4;margin:0;padding:20px}
    .container{max-width:920px;margin:auto;background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
    textarea{width:100%;height:260px;margin-top:10px;padding:10px;font-family:monospace}
    .btn-group{margin:10px 0;text-align:center}
    .btn-group input[type=file],.btn-group button{margin:6px 4px;padding:10px 16px;font-size:16px}
  </style>
</head>
<body>
  <div class="container">
    <h2>CSV ⇄ JSON 格式转换</h2>

    <!-- CSV ➜ JSON -->
    <div class="btn-group">
      <input type="file" id="csvFile" accept=".csv" />
      <button id="downloadJson">CSV → JSON 下载</button>
    </div>

    <!-- JSON ➜ CSV -->
    <div class="btn-group">
      <textarea id="jsonInput" placeholder="在此粘贴 JSON（支持嵌套对象/数组，会自动展开）..."></textarea>
      <button id="downloadCsv">JSON → CSV 下载</button>
    </div>

    <!-- 输出区 -->
    <div class="btn-group"><button id="clearBtn">清空</button></div>
    <textarea id="output" placeholder="输出内容显示在此..."></textarea>
  </div>

<script>
// 辅助：展开嵌套对象/数组为平铺键
function flattenObject(obj, parentKey = '', res = {}) {
  for (const [key, value] of Object.entries(obj)) {
    const newKey = parentKey ? `${parentKey}.${key}` : key;
    if (Array.isArray(value)) {
      // 数组：转为用 ';' 连接的字符串
      res[newKey] = value.join(';');
    } else if (value !== null && typeof value === 'object') {
      flattenObject(value, newKey, res);
    } else {
      res[newKey] = value;
    }
  }
  return res;
}

const output = document.getElementById('output');
let csvJsonData = null; // 存储从 CSV 解析的 JSON

// CSV -> JSON
csvFile.onchange = e => {
  const file = e.target.files[0];
  if(!file) return;
  Papa.parse(file,{header:true,skipEmptyLines:true,complete:r=>{
    csvJsonData = r.data;
    output.value = JSON.stringify(csvJsonData,null,2);
  },error:()=>alert('解析 CSV 失败')});
};

downloadJson.onclick = () => {
  if(!csvJsonData) return alert('请先上传 CSV');
  const blob = new Blob([JSON.stringify(csvJsonData,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement('a'),{href:url,download:'converted.json'});
  a.click(); URL.revokeObjectURL(url);
};

// JSON -> CSV
function convertJsonToCsv(jsonStr){
  let data;
  try{data = JSON.parse(jsonStr);}catch(e){throw new Error('无效 JSON');}
  if(!Array.isArray(data)) throw new Error('JSON 须为数组');
  const flatData = data.map(d=>flattenObject(d));
  return Papa.unparse(flatData);
}

downloadCsv.onclick = () => {
  try{
    const csv = convertJsonToCsv(jsonInput.value.trim());
    output.value = csv;
    const blob = new Blob([csv],{type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'),{href:url,download:'converted.csv'});
    a.click(); URL.revokeObjectURL(url);
  }catch(err){alert(err.message);} 
};

clearBtn.onclick = () => {
  output.value = jsonInput.value = ''; csvJsonData = null; csvFile.value='';
};
</script>
</body>
</html>
